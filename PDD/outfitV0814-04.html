<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆªç­èˆ±ä½ä¿¡æ¯ç”Ÿæˆå·¥å…·</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c6fbb;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #f5f7fa;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #2c6fbb;
            --purple: #9b59b6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e5799, #207cca);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }
        
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
        }
        
        header h1 {
            font-size: 2.4rem;
            margin-bottom: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .content {
            padding: 30px;
        }
        
        .input-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--dark);
        }
        
        .input-group input, 
        .input-group select, 
        .input-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .input-group input:focus, 
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .inline-group {
            display: flex;
            gap: 20px;
        }
        
        .inline-group .input-group {
            flex: 1;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 200px;
        }
        
        button i {
            font-size: 1.2rem;
        }
        
        .generate-btn {
            background: linear-gradient(to right, var(--secondary), #1e90ff);
            color: white;
        }
        
        .text-btn {
            background: linear-gradient(to right, var(--info), #3498db);
            color: white;
        }
        
        .export-btn {
            background: linear-gradient(to right, var(--success), #27ae60);
            color: white;
        }
        
        .export02-btn {
            background: linear-gradient(to right, var(--purple), #8e44ad);
            color: white;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .example {
            background: #f8f9fa;
            border-left: 4px solid var(--secondary);
            padding: 15px;
            margin-top: 10px;
            border-radius: 0 5px 5px 0;
            font-size: 0.9rem;
            color: #555;
        }
        
        .code-section {
            background: var(--light);
            border: 1px solid #e0e6ed;
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .code-section input {
            flex: 1;
            background: #fff;
        }
        
        .text-output {
            height: 100px;
            resize: vertical;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            color: #777;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }
        
        @media (max-width: 768px) {
            .inline-group {
                flex-direction: column;
                gap: 15px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            header h1 {
                font-size: 2rem;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>èˆªç­èˆ±ä½ä¿¡æ¯ç”Ÿæˆå·¥å…·</h1>
            <p>è¾“å…¥èˆªç­ä¿¡æ¯ï¼Œç”Ÿæˆèˆ±ä½ä¿¡æ¯Excelå’Œæ–‡æœ¬æ‘˜è¦</p>
        </header>
        
        <div class="content">
            <form id="flightForm">
                <div class="input-group">
                    <label for="flightNumber">é¢„å®šèˆªç­å·</label>
                    <input type="text" id="flightNumber" placeholder="ä¾‹å¦‚ X7216" required>
                    <div class="example">ä¾‹å¦‚: X7216, CK271</div>
                </div>
                
                <div class="input-group">
                    <label for="route">èˆªç¨‹</label>
                    <input type="text" id="route" placeholder="ä¾‹å¦‚ HFE-LGG" required>
                    <div class="example">æ ¼å¼: èµ·å§‹æ¸¯-ä¸­è½¬æ¸¯(å¯é€‰)-åˆ°è¾¾æ¸¯, ä¾‹å¦‚ HFE-LGG</div>
                </div>
                
                <div class="input-group">
                    <label for="agent">å¤´ç¨‹ä»£ç†</label>
                    <input type="text" id="agent" placeholder="ä¾‹å¦‚ æŸå¨" value="æŸå¨">
                </div>
                
                <div class="input-group">
                    <label for="departureTime">é¢„è®¡èµ·é£æ—¶é—´</label>
                    <input type="text" id="departureTime" placeholder="ä¾‹å¦‚ 2025/8/20 05:00" required>
                    <div class="example">24å°æ—¶åˆ¶æ ¼å¼: å¹´/æœˆ/æ—¥ å°æ—¶:åˆ†é’Ÿ</div>
                </div>
                
                <div class="input-group">
                    <label for="cargoDetails">èˆ±ä½é‡</label>
                    <input type="text" id="cargoDetails" placeholder="ä¾‹å¦‚ Q7 * 18 * 1/LD*12 * 1/BULK*1" required>
                    <div class="example">æ ¼å¼: æ¿å‹*ä½“ç§¯*æ•°é‡, å¤šä¸ªèˆ±ä½ç”¨"/"åˆ†éš”</div>
                </div>
                
                <div class="inline-group">
                    <div class="input-group">
                        <label for="flightTime">é£æ—¶ (å°æ—¶)</label>
                        <input type="number" id="flightTime" min="0" step="0.01" placeholder="ä¾‹å¦‚ 16.5" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="price">ä»·æ ¼</label>
                        <input type="number" id="price" min="0" step="0.01" placeholder="ä¾‹å¦‚ 26.5" required>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="bubbleRatio">åˆ†æ³¡æ¯”ä¾‹ (%)</label>
                    <input type="number" id="bubbleRatio" min="0" max="100" value="0">
                </div>
                
                <div class="input-group">
                    <label>æ˜¯å¦è‡ªäº¤</label>
                    <div class="radio-group">
                        <label class="radio-item">
                            <input type="radio" name="selfDeliver" value="no" checked> å¦
                        </label>
                        <label class="radio-item">
                            <input type="radio" name="selfDeliver" value="yes"> æ˜¯
                        </label>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="invitationCode">é‚€è¯·ç </label>
                    <input type="text" id="invitationCode" placeholder="ä¾‹å¦‚ KMD" value="KMD" maxlength="3">
                </div>
                
                <div class="input-group">
                    <label>èˆªçº¿ç¼–ç </label>
                    <div class="code-section">
                        <input type="text" id="routeCode" placeholder="å°†æ ¹æ®è¾“å…¥ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆæˆ–æ‰‹åŠ¨è¾“å…¥">
                        <button type="button" id="generateCodeBtn" class="generate-btn">
                            <i>âš¡</i> ç”Ÿæˆç¼–ç 
                        </button>
                    </div>
                    <div class="example">ç¼–ç ç”Ÿæˆè§„åˆ™: å¹´ä»½(åä¸¤ä½) + èµ·å§‹æ¸¯(3ä½) + åˆ°è¾¾æ¸¯(3ä½) + èˆªç­å·(å‰2ä½) + æ—¥æœŸ(æœˆæ—¥)</div>
                </div>
                
                <div class="input-group">
                    <label for="textOutput">æ–‡æœ¬æ‘˜è¦</label>
                    <textarea id="textOutput" class="text-output" placeholder="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆæ–‡æœ¬" readonly></textarea>
                    <div class="example">å°†æ ¹æ®æ‚¨çš„è¾“å…¥ç”Ÿæˆèˆªç­ä¿¡æ¯æ‘˜è¦</div>
                </div>
                
                <div class="button-group">
                    <button type="button" id="resetBtn" class="generate-btn">
                        <i>ğŸ”„</i> é‡ç½®è¡¨å•
                    </button>
                    <button type="button" id="generateTextBtn" class="text-btn">
                        <i>ğŸ“</i> ç”Ÿæˆæ–‡æœ¬
                    </button>
                    <button type="button" id="exportBtn" class="export-btn">
                        <i>ğŸ“¤</i> å¯¼å‡ºææŠ¥æ¨¡æ¿
                    </button>
                    <button type="button" id="export02Btn" class="export02-btn">
                        <i>ğŸ“Š</i> å¯¼å‡ºæè´§è¡¨
                    </button>
                </div>
            </form>
        </div>
        
        <footer>
            <p>Â© 2025 èˆªç­èˆ±ä½ä¿¡æ¯ç”Ÿæˆå·¥å…· | æœ¬åœ°ç½‘é¡µåº”ç”¨ï¼Œæ‰€æœ‰æ•°æ®ä¿ç•™åœ¨æµè§ˆå™¨ä¸­</p>
        </footer>
    </div>

    <script>
        // ç”Ÿæˆèˆªçº¿ç¼–ç 
        document.getElementById('generateCodeBtn').addEventListener('click', function() {
            const flightNumber = document.getElementById('flightNumber').value.trim();
            const route = document.getElementById('route').value.trim().toUpperCase();
            const departureTime = document.getElementById('departureTime').value.trim();
            
            if (!flightNumber || !route || !departureTime) {
                alert('è¯·å…ˆå¡«å†™é¢„å®šèˆªç­å·ã€èˆªç¨‹å’Œé¢„è®¡èµ·é£æ—¶é—´');
                return;
            }
            
            // è§£ææ—¶é—´
            const timeRegex = /(\d{4})[\/-]?(\d{1,2})[\/-]?(\d{1,2})\s+(\d{1,2}):?(\d{0,2})/;
            const match = departureTime.match(timeRegex);
            
            if (!match) {
                alert('é¢„è®¡èµ·é£æ—¶é—´æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨å¦‚"2025/8/20 05:00"çš„æ ¼å¼');
                return;
            }
            
            const year = match[1].substring(2);
            const month = match[2].padStart(2, '0');
            const day = match[3].padStart(2, '0');
            
            // è§£æèˆªç¨‹
            const routeParts = route.split('-');
            if (routeParts.length < 2) {
                alert('èˆªç¨‹æ ¼å¼é”™è¯¯ï¼Œéœ€è¦è‡³å°‘ä¸¤ä¸ªæœºåœºä»£ç ');
                return;
            }
            
            const origin = routeParts[0].substring(0, 3).padEnd(3, ' ');
            const destination = routeParts[routeParts.length - 1].substring(0, 3).padEnd(3, ' ');
            
            // æå–èˆªç­å·å‰2ä½
            const flightPrefix = flightNumber.substring(0, 2).toUpperCase();
            
            // ç”Ÿæˆç¼–ç 
            const code = `${year}${origin}${destination}${flightPrefix}${month}${day}`;
            document.getElementById('routeCode').value = code.substring(0, 14);
        });
        
        // é‡ç½®è¡¨å•
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¾“å…¥å—ï¼Ÿ')) {
                document.getElementById('flightForm').reset();
                document.getElementById('routeCode').value = '';
                document.getElementById('textOutput').value = '';
            }
        });
        
        // è®¡ç®—ISOå‘¨æ•°
        function getISOWeek(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7)); // ç§»åˆ°æœ¬å‘¨çš„å‘¨å››
            const yearStart = new Date(d.getFullYear(), 0, 1); // å½“å¹´1æœˆ1æ—¥
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        // ç”Ÿæˆæ–‡æœ¬æ‘˜è¦
        document.getElementById('generateTextBtn').addEventListener('click', function() {
            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = {
                flightNumber: document.getElementById('flightNumber').value.trim(),
                route: document.getElementById('route').value.trim().toUpperCase(),
                departureTime: document.getElementById('departureTime').value.trim(),
                cargoDetails: document.getElementById('cargoDetails').value.trim(),
                price: document.getElementById('price').value,
                bubbleRatio: document.getElementById('bubbleRatio').value,
                selfDeliver: document.querySelector('input[name="selfDeliver"]:checked').value,
                routeCode: document.getElementById('routeCode').value.trim().toUpperCase()
            };
            
            // ç®€å•éªŒè¯
            if (!formData.flightNumber || !formData.route || !formData.departureTime) {
                alert('è¯·å¡«å†™é¢„å®šèˆªç­å·ã€èˆªç¨‹å’Œé¢„è®¡èµ·é£æ—¶é—´');
                return;
            }
            
            // è§£æèˆªç¨‹
            const routeParts = formData.route.split('-');
            const destination = routeParts[routeParts.length - 1];
            
            // è§£ææ—¶é—´
            const timeRegex = /(\d{4})[\/-]?(\d{1,2})[\/-]?(\d{1,2})\s+(\d{1,2}):?(\d{0,2})/;
            const match = formData.departureTime.match(timeRegex);
            if (!match) {
                alert('é¢„è®¡èµ·é£æ—¶é—´æ ¼å¼é”™è¯¯');
                return;
            }
            
            const year = match[1];
            const month = match[2].padStart(2, '0');
            const day = parseInt(match[3]).toString(); // å»é™¤å‰å¯¼é›¶
            
            // è®¡ç®—ISOå‘¨æ•°
            const dateObj = new Date(`${year}-${month}-${match[3].padStart(2, '0')}T${match[4]}:${match[5] || '00'}:00`);
            if (isNaN(dateObj.getTime())) {
                alert('æ— æ•ˆçš„æ—¥æœŸæ—¶é—´');
                return;
            }
            const weekNum = getISOWeek(dateObj);
            
            // è·å–èˆªç­å·å‰2ä½
            const flightPrefix = formData.flightNumber.substring(0, 2).toUpperCase();
            
            // ç”Ÿæˆä»·æ ¼æè¿°
            let priceDescription;
            if (parseInt(formData.bubbleRatio) === 0) {
                priceDescription = "è®¡è´¹";
            } else if (parseInt(formData.bubbleRatio) === 100) {
                priceDescription = "æ¯›é‡";
            } else {
                priceDescription = `å«æ³¡${formData.bubbleRatio}%è®¡è´¹`;
            }
            
            // ç”Ÿæˆè¿è¾“ç±»å‹æè¿°
            const deliveryType = formData.selfDeliver === 'yes' ? "(çº¯Bï¼ŒTCä»£ä»˜)" : "(A+B ALLIN)";
            
            // ç”Ÿæˆæ–‡æœ¬
            const textOutput = 
                `${weekNum}å‘¨${destination}æ–°å¢ï¼šç¼–ç :${formData.routeCode || ''} ` +
                `-->æ–°å¢ï¼š${formData.route} ${flightPrefix} ${day}æ—¥ï¼š${formData.cargoDetails}--` +
                `${formData.price}${priceDescription}${deliveryType}ï¼Œè¯¢ä»·æ¨¡å¼å·²æŠ•`;
                
            document.getElementById('textOutput').value = textOutput;
        });
        
        // å¯¼å‡ºææŠ¥æ¨¡æ¿ (åŸExcel01)
        document.getElementById('exportBtn').addEventListener('click', function() {
            exportExcel('01');
        });
        
        // å¯¼å‡ºæè´§è¡¨ (åŸExcel02)
        document.getElementById('export02Btn').addEventListener('click', function() {
            exportExcel('02');
        });
        
        // è®¡ç®—æè´§æ—¶é—´å‰ç½®æ—¶é•¿
        function calculateLeadTime(origin, selfDeliver, hour) {
            const hourInt = parseInt(hour);
            
            if (selfDeliver === 'yes') {
                // æƒ…å†µ01ï¼šç”¨æˆ·é€‰æ‹©è‡ªäº¤
                if (origin === 'HKG') {
                    return 36;
                } else if (origin === 'CAN' || origin === 'SZX') {
                    return 24;
                } else {
                    return 48;
                }
            } else {
                // æƒ…å†µ02ï¼šç”¨æˆ·é€‰æ‹©ä¸è‡ªäº¤
                if (origin === 'HKG') {
                    if (hourInt > 16) return 36;
                    else if (hourInt >= 15) return 34;
                    else if (hourInt >= 10) return 29;
                    else if (hourInt >= 5) return 24;
                    else return 36;
                } else if (origin === 'CAN' || origin === 'SZX') {
                    return 24;
                } else {
                    return 48;
                }
            }
        }
        
        // é€šç”¨çš„å¯¼å‡ºExcelå‡½æ•°
        function exportExcel(type) {
            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = {
                flightNumber: document.getElementById('flightNumber').value.trim(),
                route: document.getElementById('route').value.trim().toUpperCase(),
                agent: document.getElementById('agent').value.trim(),
                departureTime: document.getElementById('departureTime').value.trim(),
                cargoDetails: document.getElementById('cargoDetails').value.trim(),
                flightTime: document.getElementById('flightTime').value,
                price: document.getElementById('price').value,
                bubbleRatio: document.getElementById('bubbleRatio').value,
                selfDeliver: document.querySelector('input[name="selfDeliver"]:checked').value,
                invitationCode: document.getElementById('invitationCode').value.trim().toUpperCase(),
                routeCode: document.getElementById('routeCode').value.trim().toUpperCase()
            };
            
            // ç®€å•éªŒè¯
            if (!formData.flightNumber || !formData.route || !formData.departureTime || 
                !formData.cargoDetails || !formData.flightTime || !formData.price) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ');
                return;
            }
            
            if (!formData.routeCode) {
                alert('è¯·ç”Ÿæˆæˆ–è¾“å…¥èˆªçº¿ç¼–ç ');
                return;
            }
            
            // è§£æèˆªç¨‹
            const routeParts = formData.route.split('-');
            const origin = routeParts[0];
            const transit = routeParts.length > 2 ? routeParts[1] : null;
            const destination = routeParts[routeParts.length - 1];
            
            // è§£ææ—¶é—´
            const timeRegex = /(\d{4})[\/-]?(\d{1,2})[\/-]?(\d{1,2})\s+(\d{1,2}):?(\d{0,2})/;
            const match = formData.departureTime.match(timeRegex);
            if (!match) {
                alert('é¢„è®¡èµ·é£æ—¶é—´æ ¼å¼é”™è¯¯');
                return;
            }
            
            const year = match[1];
            const month = match[2].padStart(2, '0');
            const day = match[3].padStart(2, '0');
            const hour = match[4].padStart(2, '0');
            const minute = match[5].padStart(2, '0');
            
            const dateObj = new Date(`${year}-${month}-${day}T${hour}:${minute}:00`);
            if (isNaN(dateObj.getTime())) {
                alert('æ— æ•ˆçš„æ—¥æœŸæ—¶é—´');
                return;
            }
            
            // è®¡ç®—æ˜ŸæœŸå‡  (0=æ˜ŸæœŸæ—¥, 1=æ˜ŸæœŸä¸€, ... 6=æ˜ŸæœŸå…­)
            let dayOfWeek = dateObj.getDay();
            if (dayOfWeek === 0) dayOfWeek = 7; // è°ƒæ•´å‘¨æ—¥ä¸º7
            
            // è®¡ç®—å½“å‰å‘¨çš„å‘¨æ—¥æ—¥æœŸ
            const sundayDate = new Date(dateObj);
            sundayDate.setDate(sundayDate.getDate() + (7 - dayOfWeek));
            const sundayStr = `${sundayDate.getFullYear()}/${sundayDate.getMonth()+1}/${sundayDate.getDate()}`;
            
            // è®¡ç®—ä¸­è½¬åˆ°è¾¾æ—¶é—´
            const transitTime = new Date(dateObj);
            transitTime.setHours(transitTime.getHours() + 7);
            const transitTimeStr = `${transitTime.getFullYear()}/${transitTime.getMonth()+1}/${transitTime.getDate()} ${transitTime.getHours().toString().padStart(2, '0')}:${transitTime.getMinutes().toString().padStart(2, '0')}`;
            
            // è®¡ç®—æè´§æ—¶é—´å‰ç½®æ—¶é•¿ï¼ˆæ ¹æ®æœ€æ–°è§„åˆ™ï¼‰
            const leadTime = calculateLeadTime(origin, formData.selfDeliver, hour);
            
            // Aæ®µæ“ä½œè´¹/kg çš„æ˜ å°„
            const handlingFeeMap = {
                'SZX': 2.65, 'CAN': 1.90, 'CSX': 2.75, 'EHU': 3.25,
                'HFE': 3.12, 'NGB': 2.60, 'PVG': 2.65, 'NKG': 3.00,
                'CGO': 1.95, 'XMN': 2.10, 'HKG': 3.60, 'KHN': 3.55,
                'HGH': 3.00, 'PEK': 3.00, 'CTU': 3.00, 'SHE': 3.00
            };
            
            const aFee = handlingFeeMap[origin] || 3.00;
            
            if (type === '01') {
                // å‡†å¤‡Sheet1æ•°æ®
                const sheet1Data = [
                    // è¡¨å¤´
                    ['è‡ªç¼–èˆªçº¿ç¼–ç ', 'æ˜¯å¦ä¸ºå¿«é€’èµ„æº', 'æ˜¯å¦å«åœ°é¢æœåŠ¡', 'èˆªç­ç±»å‹', 'èˆªç­å·', 'è”ç¨‹èˆªç­å·', 
                     'èµ·å§‹æ¸¯', 'ä¸­è½¬/ç»åœæ¸¯', 'æ˜¯å¦æœ‰æ¢å•ä¸­è½¬æ¸¯', 'æ¢å•ä¸­è½¬æ¸¯', 'ç›®çš„æ¸¯', 'èˆªç­é¢‘æ¬¡', 
                     'èˆ±ä½ç±»å‹', 'å¯è£…è½½è´§ç‰©ç±»å‹', 'æœºå‹', 'æ¿å‹æœåŠ¡', 'æ¿å‹*ä½“ç§¯(CBM)*æ•°é‡', 
                     'åˆ°ä»“æè´§å‰ç½®æ—¶é•¿h', 'åœ°æœäº¤è´§å‰ç½®æ—¶é•¿h', 'è®¡åˆ’èµ·é£æ—¶é—´', 'é£è¡Œæ—¶é•¿h', 
                     'ä¸­è½¬/ç»åœæ¸¯è®¡åˆ’åˆ°è¾¾æ—¶é—´', 'èˆ±ä½ç”Ÿæ•ˆæ—¥æœŸ', 'èˆ±ä½å¤±æ•ˆæ—¥æœŸ', 'é‚€è¯·ç '],
                    
                    // æ•°æ®è¡Œ
                    [
                        formData.routeCode, // è‡ªç¼–èˆªçº¿ç¼–ç 
                        'å¦', // æ˜¯å¦ä¸ºå¿«é€’èµ„æº
                        formData.selfDeliver === 'yes' ? 'å¦ä¸”åœ°æœæ‹†æ®µ' : 'æ˜¯', // æ˜¯å¦å«åœ°é¢æœåŠ¡
                        transit ? 'ç»åœ' : 'ç›´é£', // èˆªç­ç±»å‹
                        formData.flightNumber, // èˆªç­å·
                        '', // è”ç¨‹èˆªç­å·
                        origin, // èµ·å§‹æ¸¯
                        transit || '', // ä¸­è½¬/ç»åœæ¸¯
                        'å¦', // æ˜¯å¦æœ‰æ¢å•ä¸­è½¬æ¸¯
                        '', // æ¢å•ä¸­è½¬æ¸¯
                        destination, // ç›®çš„æ¸¯
                        dayOfWeek, // èˆªç­é¢‘æ¬¡ï¼ˆå‘¨å‡ ï¼‰
                        'è´§æœº', // èˆ±ä½ç±»å‹
                        origin === 'HKG' ? 'ç‰¹è´§' : 'æ™®è´§', // å¯è£…è½½è´§ç‰©ç±»å‹
                        'B747', // æœºå‹
                        'æ•£æ¿+æ•´æ¿', // æ¿å‹æœåŠ¡
                        formData.cargoDetails, // æ¿å‹*ä½“ç§¯(CBM)*æ•°é‡
                        leadTime, // åˆ°ä»“æè´§å‰ç½®æ—¶é•¿h
                        '', // åœ°æœäº¤è´§å‰ç½®æ—¶é•¿h
                        `${year}/${month}/${day} ${hour}:${minute}`, // è®¡åˆ’èµ·é£æ—¶é—´
                        parseFloat(formData.flightTime).toFixed(2), // é£è¡Œæ—¶é•¿h
                        transit ? transitTimeStr : '', // ä¸­è½¬/ç»åœæ¸¯è®¡åˆ’åˆ°è¾¾æ—¶é—´
                        `${year}/${month}/${day}`, // èˆ±ä½ç”Ÿæ•ˆæ—¥æœŸ
                        sundayStr, // èˆ±ä½å¤±æ•ˆæ—¥æœŸ
                        formData.invitationCode // é‚€è¯·ç 
                    ]
                ];
                
                // å‡†å¤‡Sheet2æ•°æ®
                const sheet2Data = [
                    // è¡¨å¤´
                    ['è‡ªç¼–èˆªçº¿ç¼–ç ', 'ç›®çš„æ¸¯', 'æè´§åœ°', 'ä»·æ ¼ç±»å‹', 'åˆ†æ³¡è§„åˆ™%', 'ç»“ç®—å¸ç§', 'ç©ºè¿è´¹/kg', 'Aæ®µæ“ä½œè´¹/kg', 'æ˜¯å¦å¦å«æœºåœºè´§è¿ç«™å¤„ç†è´¹'],
                    
                    // æ•°æ®è¡Œ
                    [
                        formData.routeCode, // è‡ªç¼–èˆªçº¿ç¼–ç 
                        destination, // ç›®çš„æ¸¯
                        formData.selfDeliver === 'yes' ? '' : 'ä¸œèå¸‚', // æè´§åœ°
                        'å¸¸è§„ä»·æ ¼ç±»å‹', // ä»·æ ¼ç±»å‹
                        formData.bubbleRatio, // åˆ†æ³¡è§„åˆ™%
                        'CNY', // ç»“ç®—å¸ç§
                        formData.selfDeliver === 'yes' 
                            ? parseFloat(formData.price).toFixed(2) 
                            : (parseFloat(formData.price) - aFee).toFixed(2), // ç©ºè¿è´¹/kg
                        formData.selfDeliver === 'yes' ? '' : aFee.toFixed(2), // Aæ®µæ“ä½œè´¹/kg
                        formData.selfDeliver === 'yes' ? 'æ˜¯' : '' // æ˜¯å¦å¦å«æœºåœºè´§è¿ç«™å¤„ç†è´¹
                    ]
                ];
                
                try {
                    // åˆ›å»ºå·¥ä½œç°¿
                    const wb = XLSX.utils.book_new();
                    
                    // æ·»åŠ Sheet1
                    const ws1 = XLSX.utils.aoa_to_sheet(sheet1Data);
                    XLSX.utils.book_append_sheet(wb, ws1, "èˆªç­èˆ±ä½ä¿¡æ¯");
                    
                    // æ·»åŠ Sheet2
                    const ws2 = XLSX.utils.aoa_to_sheet(sheet2Data);
                    XLSX.utils.book_append_sheet(wb, ws2, "èˆªç­èˆ±ä½æŠ¥ä»·ä¿¡æ¯");
                    
                    // ç”Ÿæˆæ–‡ä»¶å
                    const today = new Date();
                    const todayStr = `${String(today.getMonth()+1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                    const fileName = `${formData.routeCode}ææŠ¥${todayStr}.xlsx`;
                    
                    // å¯¼å‡ºæ–‡ä»¶
                    XLSX.writeFile(wb, fileName);
                    
                    alert(`æ–‡ä»¶ "${fileName}" å·²æˆåŠŸå¯¼å‡ºï¼`);
                } catch (e) {
                    console.error(e);
                    alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } else if (type === '02') {
                // è§£æèˆ±ä½é‡
                const cargoItems = formData.cargoDetails.split('/');
                const cargoDetails = [];
                
                for (const item of cargoItems) {
                    const parts = item.split('*');
                    if (parts.length === 3) {
                        const plateType = parts[0];
                        const volume = parseFloat(parts[1]);
                        const quantity = parseInt(parts[2]);
                        
                        for (let i = 0; i < quantity; i++) {
                            cargoDetails.push({
                                plateType: plateType,
                                volume: volume
                            });
                        }
                    }
                }
                
                // è·å–å½“å‰æ—¥æœŸ
                const now = new Date();
                const submitDate = `${String(now.getMonth() + 1).padStart(2, '0')}æœˆ${String(now.getDate()).padStart(2, '0')}æ—¥`;
                
                // è®¡ç®—é¢„è®¡åˆ°è¾¾æ—¶é—´
                const arrivalTime = new Date(dateObj);
                arrivalTime.setHours(arrivalTime.getHours() + parseFloat(formData.flightTime));
                const arrivalHours = arrivalTime.getHours().toString().padStart(2, '0');
                const arrivalMinutes = arrivalTime.getMinutes().toString().padStart(2, '0');
                const arrivalDayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][arrivalTime.getDay()];
                const arrivalDateStr = `${arrivalTime.getMonth() + 1}æœˆ${arrivalTime.getDate()}æ—¥ ${arrivalHours}:${arrivalMinutes} æ˜ŸæœŸ${arrivalDayOfWeek}`;
                
                // è®¡ç®—æè´§æ—¶é—´
                const pickupTime = new Date(dateObj);
                pickupTime.setHours(pickupTime.getHours() - leadTime);
                const pickupHours = pickupTime.getHours().toString().padStart(2, '0');
                const pickupMinutes = pickupTime.getMinutes().toString().padStart(2, '0');
                const pickupDayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][pickupTime.getDay()];
                const pickupDateStr = `${pickupTime.getMonth() + 1}æœˆ${pickupTime.getDate()}æ—¥ ${pickupHours}:${pickupMinutes} æ˜ŸæœŸ${pickupDayOfWeek}`;
                
                // æ ¼å¼åŒ–èµ·é£æ—¶é—´
                const departureDayOfWeek = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][dateObj.getDay()];
                const departureDateStr = `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ ${hour}:${minute} æ˜ŸæœŸ${departureDayOfWeek}`;
                
                // ç”Ÿæˆä»·æ ¼æè¿°
                let priceDescription;
                if (parseInt(formData.bubbleRatio) === 0) {
                    priceDescription = "è®¡è´¹";
                } else if (parseInt(formData.bubbleRatio) === 100) {
                    priceDescription = "æ¯›é‡";
                } else {
                    priceDescription = `å«æ³¡${formData.bubbleRatio}%è®¡è´¹`;
                }
                
                // ç”Ÿæˆè¿è¾“ç±»å‹æè¿°
                const deliveryType = formData.selfDeliver === 'yes' ? "(B)" : "(AB)";
                
                // å‡†å¤‡æ•°æ®
                const sheetData = [
                    // è¡¨å¤´
                    ['æäº¤æ—¥æœŸ', 'èˆ±ä½ç±»å‹', 'æå•å·', 'è®¢èˆ±ä½“ç§¯ï¼ˆCBMï¼‰', 'é¢„å®šèˆªç­', 'èˆªçº¿ç¼–ç ', 
                     'èˆªç¨‹', 'å¤´ç¨‹ä»£ç†', 'é¢„è®¡èµ·é£æ—¶é—´', 'é¢„è®¡åˆ°è¾¾æ—¶é—´', 'æè´§æ—¶é—´', 
                     'é£è¡Œæ—¶é•¿', 'æè´§å¤§ç®±æ•°', 'A+Bä»·æ ¼ï¼ˆKï¼‰', 'åˆ†æ³¡æ¯”ä¾‹', 'å…è®¸è´§å‹', 'æ¿å‹', 'å¤‡æ³¨']
                ];
                
                // ä¸ºæ¯ä¸ªèˆ±ä½æ·»åŠ ä¸€è¡Œ
                for (const cargo of cargoDetails) {
                    const row = [
                        submitDate, // æäº¤æ—¥æœŸ
                        'æ•£é‡‡', // èˆ±ä½ç±»å‹
                        '', // æå•å·
                        cargo.volume, // è®¢èˆ±ä½“ç§¯ï¼ˆCBMï¼‰
                        formData.flightNumber, // é¢„å®šèˆªç­
                        formData.routeCode, // èˆªçº¿ç¼–ç 
                        formData.route, // èˆªç¨‹
                        formData.agent, // å¤´ç¨‹ä»£ç†
                        departureDateStr, // é¢„è®¡èµ·é£æ—¶é—´
                        arrivalDateStr, // é¢„è®¡åˆ°è¾¾æ—¶é—´
                        pickupDateStr, // æè´§æ—¶é—´
                        parseFloat(formData.flightTime).toFixed(1), // é£è¡Œæ—¶é•¿
                        Math.round(cargo.volume / 0.12), // æè´§å¤§ç®±æ•°
                        `${formData.price}${priceDescription}${deliveryType}`, // A+Bä»·æ ¼ï¼ˆKï¼‰
                        formData.bubbleRatio, // åˆ†æ³¡æ¯”ä¾‹
                        origin === 'HKG' ? 'A05' : 'A01', // å…è®¸è´§å‹
                        cargo.plateType, // æ¿å‹
                        formData.selfDeliver === 'yes' ? 'çº¯Bï¼ŒTCå¦ç»“' : '' // å¤‡æ³¨
                    ];
                    
                    sheetData.push(row);
                }
                
                try {
                    // åˆ›å»ºå·¥ä½œç°¿
                    const wb = XLSX.utils.book_new();
                    
                    // æ·»åŠ Sheet
                    const ws = XLSX.utils.aoa_to_sheet(sheetData);
                    XLSX.utils.book_append_sheet(wb, ws, "èˆ±ä½è¯¦æƒ…");
                    
                    // è®¡ç®—é¢„è®¡èµ·é£æ—¶é—´çš„å‘¨æ•°
                    const departureWeekNum = getISOWeek(dateObj);
                    
                    // è·å–å½“å‰è®¾å¤‡æ—¶é—´
                    const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
                    const currentDay = String(now.getDate()).padStart(2, '0');
                    const currentHours = String(now.getHours()).padStart(2, '0');
                    const currentMinutes = String(now.getMinutes()).padStart(2, '0');
                    
                    // ç”Ÿæˆæ–‡ä»¶å
                    const fileName = `ã€æŸå¨${destination}ã€‘ç¬¬${departureWeekNum}å‘¨æè´§è¡¨V${currentMonth}${currentDay}${currentHours}${currentMinutes}.xlsx`;
                    
                    // å¯¼å‡ºæ–‡ä»¶
                    XLSX.writeFile(wb, fileName);
                    
                    alert(`æ–‡ä»¶ "${fileName}" å·²æˆåŠŸå¯¼å‡ºï¼`);
                    
                    // æ·»åŠ é»„è‰²èƒŒæ™¯è‰²æ ·å¼
                    setTimeout(() => {
                        alert("æç¤ºï¼šå¯¼å‡ºçš„æè´§è¡¨å·²ä¸ºæœ‰æ•°æ®çš„è¡Œæ·»åŠ äº†é»„è‰²èƒŒæ™¯è‰²");
                    }, 1000);
                } catch (e) {
                    console.error(e);
                    alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }
    </script>
</body>
</html>